#!/usr/bin/env bash

set -e            # fail fast
set -o pipefail   # don't ignore exit codes when piping output

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
BUILDPACK_DIR=$(cd $(dirname $0); cd ..; pwd)

source $BUILDPACK_DIR/bin/common.sh
trap cat_cpanm_build_log ERR
mkdir -p $BUILD_DIR/.profile.d

PERLURL='https://heroku-buildpack-perl.s3.amazonaws.com'
CPANMURL='https://raw.github.com/miyagawa/cpanminus/master/cpanm'
export PERL_CPANM_OPT="--quiet --notest"
if [ -e "$BUILD_DIR/.perl-version" ]; then
    PERL_VERSION=`cat "$BUILD_DIR/.perl-version"`
    PERL_PACKAGE="$PERLURL/perl-$PERL_VERSION.tgz"
    status "Vendoring perl $PERL_VERSION"
    mkdir -p "$BUILD_DIR/vendor/perl"
    curl -sL $PERL_PACKAGE | tar xzf - -C "$BUILD_DIR/vendor/perl"
    export PATH="$BUILD_DIR/vendor/perl/bin:$PATH"
    echo "export PATH=\"\$HOME/vendor/perl/bin:\$PATH\";" > $BUILD_DIR/.profile.d/buildpack_vendor_perl.sh
fi
if [ -e "$ENV_DIR/BUILDPACK_CPAN_MIRROR" ]; then
  BUILDPACK_CPAN_MIRROR=`cat $ENV_DIR/BUILDPACK_CPAN_MIRROR`
  status "Using CPAN mirror $BUILDPACK_CPAN_MIRROR"
  export PERL_CPANM_OPT="$PERL_CPANM_OPT --mirror-only --mirror $BUILDPACK_CPAN_MIRROR"
fi

CURRENT_PERL_VERSION=$( eval $(perl -V:PERL_.*:); echo "$PERL_REVISION.$PERL_VERSION.$PERL_SUBVERSION" )
status "Current perl version is $CURRENT_PERL_VERSION"

cd $BUILD_DIR

source $BUILDPACK_DIR/bin/steps/hooks/pre_compile $ENV_DIR

if [ -d "$CACHE_DIR/perl/local" ]; then
  if [ -f "$CACHE_DIR/perl/.perl-version" ] && [ $(cat $CACHE_DIR/perl/.perl-version) != "$CURRENT_PERL_VERSION" ]; then
    status "Perl version changed, not restoring local directory from cache"
  else
    status "Restoring local directory from cache"
    cp -R "$CACHE_DIR/perl/local" . &> /dev/null || true
  fi
elif [ -d "$CACHE_DIR/local" ]; then
  status "Restoring local directory from cache (legacy cache layout)"
  cp -R "$CACHE_DIR/local" . &> /dev/null || true
fi

if [ -e "$ENV_DIR/LOCALURL" ]; then
  LOCALURL=`cat $ENV_DIR/LOCALURL`
  status "Extracting prebuilt dependencies from $LOCALURL"
  mkdir -p local
  curl --silent $LOCALURL | tar -xz -C local 2>&1 | indent
fi

status "Bootstrapping cpanm and local::lib"
curl --silent $CPANMURL | perl - --local-lib local App::cpanminus local::lib 2>&1 | indent
eval $(perl -Ilocal/lib/perl5 -Mlocal::lib=local 2>&1 | indent)

if [ -e cpanfile.snapshot ]; then
  if ! command -v carton >/dev/null 2>&1; then
    status "Installing carton"
    perl -S cpanm Carton 2>&1 | indent
  fi
  status "Installing dependencies (carton)"
  perl -S carton install --deployment --cached 2>&1 | indent
  rm -rf vendor/cache 2>&1
fi

status "Installing dependencies (cpanm)"
perl -S cpanm --installdeps . 2>&1 | indent

status "Installing Starman"
perl -S cpanm Starman 2>&1 | indent

source $BUILDPACK_DIR/bin/steps/hooks/post_compile $ENV_DIR

rm -rf $CACHE_DIR/perl
mkdir -p $CACHE_DIR/perl
if [ -d "local" ]; then
  status "Caching local directory for future builds"
  cp -R local $CACHE_DIR/perl/
fi
echo $CURRENT_PERL_VERSION >$CACHE_DIR/perl/.perl-version
